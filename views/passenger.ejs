<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <title>Scrolling Nav - Start Bootstrap Template</title>
    <link rel="icon" type="image/x-icon" href="/assets/favicon.ico" />

    <!-- âœ… Bootstrap 5 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Core theme CSS (includes Bootstrap)-->
    <link href="/css/styles.css" rel="stylesheet" />
  </head>
  <body id="page-top">
    <!-- Navigation-->
    <nav
      class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top"
      id="mainNav"
    >
      <div class="container px-4">
        <a class="navbar-brand" href="#page-top">Start Bootstrap</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarResponsive"
          aria-controls="navbarResponsive"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarResponsive">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link" href="/">Home</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <!-- Header-->
    <header class="bg-primary bg-gradient text-white">
      <div class="container px-4 text-center">
        <h1 class="fw-bolder">Welcome to Scrolling Nav</h1>
        <p class="lead">
          A functional Bootstrap 5 boilerplate for one page scrolling websites
        </p>
        <a class="btn btn-lg btn-light" href="#about">Start scrolling!</a>
      </div>
    </header>

    <div class="container mt-4">
      <div class="contianer">
        <h3>Passengers Details</h3>
      </div>
      <br />

      <form id="passenger-form">
        <% for (let i = 1; i <= passengers; i++) { %>
        <div class="border p-3 mb-4 passenger-block" id="passenger-<%= i %>">
          <h5>Passenger <%= i %></h5>
          <div class="row g-3">
            <!-- Title -->
            <div class="col-md-2">
              <select class="form-select" name="title-<%= i %>" required>
                <option value="Mr">Mr</option>
                <option value="Mrs">Mrs</option>
                <option value="Ms">Ms</option>
              </select>
            </div>

            <!-- Full Name -->
            <div class="col-md-4">
              <input
                type="text"
                class="form-control"
                name="name-<%= i %>"
                placeholder="Full Name*"
                required
              />
            </div>

            <!-- Age -->
            <div class="col-md-2">
              <input
                type="number"
                class="form-control"
                name="age-<%= i %>"
                placeholder="Age*"
                required
              />
            </div>
            <!-- Age -->
            <div class="col-md-2">
              <input
                type="text"
                class="form-control"
                name="sex-<%= i %>"
                placeholder="Sex*"
                required
              />
            </div>

            <!-- Nationality -->
            <div class="col-md-4">
              <select
                class="form-select country-select"
                name="country-<%= i %>"
                data-index="<%= i %>"
                required
              >
                <option value="">Select Country</option>
                <option value="India">India</option>
                <option value="USA">USA</option>
                <option value="Canada">Canada</option>
                <option value="Germany">Germany</option>
                <option value="Japan">Japan</option>
                <!-- Add more countries if needed -->
              </select>
            </div>
          </div>

          <!-- Conditional passport fields -->
          <div
            class="row g-3 mt-3 passport-fields"
            id="passport-fields-<%= i %>"
            style="display: none"
          >
            <div class="col-md-6">
              <input
                type="text"
                class="form-control"
                name="passport-<%= i %>"
                placeholder="Passport Number*"
                required
              />
            </div>
            <div class="col-md-6">
              <input
                type="date"
                class="form-control"
                name="expiry-<%= i %>"
                placeholder="Expiration Date*"
                required
              />
            </div>
          </div>
        </div>
        <% } %>
      </form>

      <div class="contianer">
        <h3>Contact Detail</h3>
      </div>
      <br />

      <form id="contactForm" class="p-4 border rounded-4">
        <div class="row g-3">
          <!-- Billing Name -->
          <div class="col-md-6">
            <input
              type="text"
              class="form-control"
              placeholder="Billing Name*"
              name="billingName"
              required
            />
          </div>

          <!-- Email Address -->
          <div class="col-md-6">
            <input
              type="email"
              class="form-control"
              placeholder="Email Address*"
              name="email"
              required
            />
          </div>

          <!-- Primary Mobile Number -->
          <div class="col-md-2">
            <select class="form-select" name="primaryCode" required>
              <option selected>IN +91</option>
              <option>US +1</option>
              <option>UK +44</option>
              <!-- Add more as needed -->
            </select>
          </div>
          <div class="col-md-4">
            <input
              type="tel"
              class="form-control"
              placeholder="Mobile Number*"
              name="mobile"
              required
            />
          </div>

          <!-- Alternate Mobile Number -->
          <div class="col-md-2">
            <select class="form-select" name="altCode" required>
              <option selected>IN +91</option>
              <option>US +1</option>
              <option>UK +44</option>
              <!-- Add more as needed -->
            </select>
          </div>
          <div class="col-md-4">
            <input
              type="tel"
              class="form-control"
              placeholder="Alternate Mobile Number"
              name="alternateMobile"
              required
            />
          </div>
        </div>

        <!-- Submit Button -->
        <div class="mt-4 text-end">
          <button type="submit" class="btn btn-primary">Submit</button>
        </div>
      </form>
    </div>

    <!-- Footer-->
    <footer class="py-5 bg-dark">
      <div class="container px-4">
        <p class="m-0 text-center text-white">
          Copyright &copy; Your Website 2023
        </p>
      </div>
    </footer>
    <!-- Bootstrap core JS-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Core theme JS-->
    <script src="/js/scripts.js"></script>
    <script>
      document.querySelectorAll(".country-select").forEach((select) => {
        select.addEventListener("change", function () {
          const index = this.dataset.index;
          const passportDiv = document.getElementById(
            "passport-fields-" + index
          );

          if (this.value !== "India" && this.value !== "") {
            passportDiv.style.display = "flex";
          } else {
            passportDiv.style.display = "none";
          }
        });
      });
      console.log(window.location.href);
    </script>

    <script>
      document
        .getElementById("contactForm")
        .addEventListener("submit", function (e) {
          e.preventDefault(); // Prevent actual form submission

          const passengersData = {};
          const passengerBlocks = document.querySelectorAll(".passenger-block");

          passengerBlocks.forEach((block, index) => {
            const i = index + 1;
            const title = block.querySelector(
              `select[name="title-${i}"]`
            ).value;
            const name = block.querySelector(`input[name="name-${i}"]`).value;
            const age = block.querySelector(`input[name="age-${i}"]`).value;
            const sex = block.querySelector(`input[name="sex-${i}"]`).value;
            const country = block.querySelector(
              `select[name="country-${i}"]`
            ).value;
            const passportField = block.querySelector(
              `input[name="passport-${i}"]`
            );
            const expiryField = block.querySelector(
              `input[name="expiry-${i}"]`
            );

            passengersData[i] = {
              title: title,
              name: name,
              age: age,
              sex: sex,
              nationality:
                country === "India" ? "indian" : country.toLowerCase(),
              fcountry: country,
              fpassport: passportField ? passportField.value : "",
              fexpdate: expiryField ? expiryField.value : "",
            };
          });

          // Collect contact form data
          const contactForm = document.getElementById("contactForm");
          const contactName = contactForm.billingName.value;
          const contactEmail = contactForm.email.value;
          const primaryMobile = contactForm.mobile.value;
          const altMobile = contactForm.alternateMobile.value;

          const finalData = {
            data: {
              passenger: passengersData,
              c_name: contactName,
              c_mobile: primaryMobile,
              c_email: contactEmail,
              p_contact: altMobile,
            },
          };

          console.log(finalData); // Debug log

          // Send POST request
          fetch(window.location.href, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(finalData),
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.status == "success") {
                console.log(data);
                alert(
                  "You Seat has been Booked Pls do make the payement and confirm your booking"
                );

                // Step 1: Get existing bookings from localStorage
                let bookings =
                  JSON.parse(localStorage.getItem("bookings")) || [];

                // Step 2: Push the new booking into the array

                // Get the current path from the browser's address bar
                const path = window.location.pathname;

                // Split the path into parts
                const parts = path.split("/");

                // Example: /savePassengers/2/771/2025-05-20/22/1625
                // Index 0: ""         (before first slash)
                // Index 1: "savePassengers"
                // Index 2: "2"        <-- no_of_passenger
                // Index 3: "771"      <-- schedule_id
                // Index 4: "2025-05-20" <-- travel_date
                // Index 5: "22"       <-- class_id
                // Index 6: "1625"     <-- fare
                let no_of_passenger;
                if (parts.length >= 3 && parts[1] === "savePassengers") {
                no_of_passenger = parseInt(parts[2]);
                  console.log("No. of passengers:", no_of_passenger);
                } else {
                  console.warn("URL structure is unexpected or invalid.");
                }
                data.data.data["no_of_passenger"] = no_of_passenger;
                bookings.push(data.data.data);

                // Step 3: Save the updated array back to localStorage
                localStorage.setItem("bookings", JSON.stringify(bookings));

                console.log("Booking added!");
              } else {
                alert(data.message);
              }
            })
            .catch((error) => {
              console.error("Error submitting data:", error);
            });
        });
    </script>
  </body>
</html>
